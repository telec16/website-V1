<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8"/>
		
		<title>Filters</title>
		
		<style>
			input[type=text] { width:3em; }
			table { border-collapse: collapse; }
			tr { height:32px; border: none;}
			td{ text-align:center;}
		</style>
		
		<link rel="stylesheet" href="/styleADL.css" />
		<script type='text/javascript' src='https://unpkg.com/mathjs@7.1.0/dist/math.min.js'></script>
		<script type='text/javascript' src='../utils.js'></script>
		<script type='text/javascript'>
			handler=null;
			function timer(type){
				clearTimeout(handler);
				handler = setTimeout(change, 500, type);
			}
			
			function change(type){
				H_div = document.getElementById("H");
				R1_input = document.getElementById("R1");
				R2_input = document.getElementById("R2");
				C1_input = document.getElementById("C1");
				C2_input = document.getElementById("C2");
				Rf_input = document.getElementById("Rf");
				K_input  = document.getElementById("K");
				F0_input = document.getElementById("F0");
				Q_input  = document.getElementById("Q");
				serie_input = document.getElementById("serie");
				
				lockR = document.getElementById("lockR").checked;
				lockC = document.getElementById("lockC").checked;
				
				ctx = document.getElementById("cnv").getContext("2d");
				
				//Change picture
				topo = document.getElementById("topology").value;
				document.getElementById("circuit").src = topo+".png";
				
				//Change configuration
				if(type == "config"){
					R2_input.disabled = lockR;
					C2_input.disabled = lockC;
					
					switch(topo){
						case "SKlp":
							Rf_input.disabled = true;
							H_div.innerHTML = "";
						break;
						case "SKhp":
							Rf_input.disabled = true;
							H_div.innerHTML = "";
						break;
						case "SKbp":
							Rf_input.disabled = false;
							H_div.innerHTML = "";
						break;
					}
				}
				
				//Get fields values
				R1 = Math.abs(floatOf(R1_input, 10 )) * 1e3 ;
				R2 = Math.abs(floatOf(R2_input, 10 )) * 1e3 ;
				C1 = Math.abs(floatOf(C1_input, 4.7)) * 1e-9;
				C2 = Math.abs(floatOf(C2_input, 4.7)) * 1e-9;
				Rf = Math.abs(floatOf(Rf_input, 1  )) * 1e3 ;
				K  = Math.abs(floatOf(K_input , 1  )) * 1e0 ;
				F0 = Math.abs(floatOf(F0_input, 1  )) * 1e3 ;
				Q  = floatOf(Q_input , 1.41)* 1e0 ;
				w0 = 2*Math.PI*F0;
				
				//Match the values
				if(lockR) R2 = R1;
				if(lockC) C2 = C1;
				
				//Compute components
				if(type == "spec"){
					switch(topo){
						case "SKlp":
							if(!lockR)
								R1 = 1/(w0**2) * 1/(R2*C1*C2);
							else
								R1 = R2 = 1/(w0 * Math.sqrt(C1*C2));
							//R2 = 1/(w0**2) * 1/(R1*C1*C2);
							//C1 = 1/(w0**2) * 1/(R1*R2*C1);
							//C2 = 1/(w0**2) * 1/(R1*R2*C2);
							K = 1 - ( (1/(Q*w0) - C2*(R1+R2)) / (R1*C1) );
						break;
						case "SKhp":
							R1 = 10;
							R2 = 10;
							C1 = 4.7;
							C2 = 4.7;
							K = 1;
						break;
						case "SKbp":
							R1 = 10;
							R2 = 10;
							C1 = 4.7;
							C2 = 4.7;
							Rf=1;
							K = 1;
						break;
					}
				}
				
				//Get closest resistance serie
				if(type == "serie"){
					s = floatOf(serie_input, 12);
					serie = getResistorSerie(s);
					
					R1 = closestInList(serie, R1);
					R2 = closestInList(serie, R2);	
					Rf = closestInList(serie, Rf);					
					
				}
				
				//Compute spec
				if(type == "comp" || type == "config"){
					switch(topo){
						case "SKlp":
							w0 = 1/Math.sqrt(R1*R2*C1*C2);
							Q = 1/w0 * 1/(C2*(R1+R2) + (R1*C1*(1-K)));
						break;
						case "SKhp":
							w0 = 1;
							Q = 1.41;
						break;
						case "SKbp":
							w0 = 1;
							Q = 1.41;
						break;
					}
				}
				
				//Create function
				switch(topo){
					case "SKlp":
						fct = function(p) { return math.complex(K).div( p.div(w0).pow(2). add(p.div(Q*w0)). add(1) );} //K/(1 + p/(Q*w0) + (p/w0)**2)
					break;
					case "SKhp":
						fct = function(p) { return 1;}
					break;
					case "SKbp":
						fct = function(p) { return 1;}
					break;
				}
				
				//Set fields (1/Infinity => NaN => 0)
				var acc = 2;
				F0 = w0/(2*Math.PI);
				setValue(R1_input, (R1||0)* 1e-3, acc);
				setValue(R2_input, (R2||0)* 1e-3, acc);
				setValue(C1_input, (C1||0)* 1e9 , acc);
				setValue(C2_input, (C2||0)* 1e9 , acc);
				setValue(Rf_input, (Rf||0)* 1e-3, acc);
				setValue(K_input , (K ||0)* 1e0 , acc);
				setValue(F0_input, (F0||0)* 1e-3, acc);
				setValue(Q_input , (Q ||0)* 1e0 , acc);
				
				drawFct(ctx, fct, w0, 300, 230);
			}
			
		function drawFct(ctx, fct, w0, xSize, ySize){
			var p, gain;
			var Ca,Cg;
			var max, min;
			var fmax, fmin;
			fmin = 0//w0-w0*3/4;
			fmax = 200e3//w0+w0*3/4;
			
			//Auto-set range
			for(Ca=0; Ca<xSize; Ca++){
				p = math.complex('i').mul(map(Ca, 0, xSize-1, fmin, fmax));
				gain = 20*Math.log(fct(p).abs());
				
				//Setup min and max
				if(Ca==0){
					max=gain;
					min=gain;
				}
				else{
					max = Math.max(max, gain);
					min = Math.min(min, gain);
				}
			}
			
			//Actual drawing
			ctx.fillStyle = "white";
			ctx.fillRect(0, 0, xSize, ySize);
			ctx.fillStyle = "black";
			for(Ca=0; Ca<xSize; Ca++){
				p = math.complex('i').mul(map(Ca, 0, xSize-1, fmin, fmax));
				gain = 20*Math.log(fct(p).abs());
				Cg = map(gain, min, max, 0, ySize-1);
				ctx.fillRect(Ca, ySize-Cg-1, 1, -1);
			}
		}
			
		</script>
	</head>
	
	<body onload="change('config');">
		<div>
			<div style="display:inline-block;">
			<table>
				<tr><td colspan="5">
				<select id="topology" onchange="change('config');">
					<option value="SKlp">Sallen-key, low-pass</option>
					<option value="SKhp">Sallen-key, high-pass</option>
					<option value="SKbp">Sallen-key, band-pass</option>
				</select>
				</td></tr>
				
				<tr><td>H(p)=</td><td colspan="4" id="H"></td></tr>
				
				<tr style="border-top-style: double;"></td><td>R1</td><td>R2</td><td>C1</td><td>C2</td><td>Rf</td></tr>
				<tr style="height:16px;">
						<td colspan="2"><input type="checkbox" id="lockR" onchange="change('config');"/></td>
						<td colspan="2"><input type="checkbox" id="lockC" onchange="change('config');"/></td></tr>
				<tr><td><input type="text" id="R1" onkeyup="timer('comp');"/></td>
						<td><input type="text" id="R2" onkeyup="timer('comp');"/></td>
						<td><input type="text" id="C1" onkeyup="timer('comp');"/></td>
						<td><input type="text" id="C2" onkeyup="timer('comp');"/></td>
						<td><input type="text" id="Rf" onkeyup="timer('comp');"/></td></tr>
						
				<tr style="border-top-style: double;"><td colspan="3">K=1+Rb/Ra=</td><td colspan="2"><input type="text" id="K" onkeyup="timer('comp');"/></td></tr>
				
				<tr style="border-top-style: double;"><td colspan="2">F0</td><td></td><td colspan="2">Q</td></tr>
				<tr><td colspan="2"><input type="text" id="F0" onkeyup="timer('spec');"/></td><td></td>
				    <td colspan="2"><input type="text" id="Q" onkeyup="timer('spec');"/></td></tr>
						
				<tr style="border-top-style: double;"><td colspan="5">
					Get closest <select id="serie" onchange="change('serie');">
						<option value="6">E6</option>
						<option value="12" selected>E12</option>
						<option value="24">E24</option>
						<option value="48">E48</option>
						<option value="96">E96</option>
						<option value="192">E192</option>
					</select> serie <input type="button" value="update" onclick="change('serie');" />
				</td></tr>
			</table>
			</div><div style="display:inline-block;">
			<img src="SKlp.png" id="circuit" width="460" height="230" alt="OpAmp circuit"/>
			</div><div style="display:inline-block;">
			<canvas id="cnv" width="300" height="230" alt="Gain vs frequency"/>
			</div>
		</div>
		(Resistors in kohms, Capacitors in nF, Frequencies in kHz)
	</body>
</html>
				